# Sproutie Outie Control Center

A Cyberpunk-themed Home Assistant dashboard with FLORA AI agent integration, Elasticsearch telemetry, automated Botany Logs, and anomaly detection for a microgreen grow tent.

## Overview

The Sproutie Outie Control Center is a high-tech monitoring and control system for a microgreen grow tent, featuring:

- **Cyberpunk UI** - Blade Runner-inspired dashboard with neon cyan/pink/amber accents
- **FLORA AI Assistant** - Friendly AI caretaker powered by Elastic Agent Builder
- **Elasticsearch Integration** - Full telemetry and anomaly detection
- **Automated Botany Logs** - Daily narrative summaries generated by FLORA
- **Real-time Monitoring** - Temperature, humidity, and control state tracking

## Architecture

```
┌─────────────────┐
│  HA Dashboard   │
│  (Cyberpunk UI) │
└────────┬────────┘
         │
    ┌────┴────┐
    │   MCP   │
    │ Server  │
    └────┬────┘
         │
    ┌────┴────────┐
    │  Elastic    │
    │ Agent       │
    │ Builder     │
    │  (FLORA)    │
    └────┬────────┘
         │
    ┌────┴────────┐
    │Elasticsearch│
    │  + ML Jobs  │
    └─────────────┘
```

## Installation

### Prerequisites

1. **Home Assistant** (Container installation)
   - HACS installed
   - Required custom cards:
     - `custom:button-card`
     - `card-mod`
     - `custom:layout-card`
     - `custom:mini-graph-card`

2. **Elastic Cloud**
   - Elasticsearch cluster
   - Agent Builder access
   - ML anomaly detection license

3. **Python Environment** (for MCP Server)
   - Python 3.9+
   - `fastmcp` package

### Setup Steps

1. **Copy package files to Home Assistant:**
   ```bash
   cp -r packages/sproutie_outie /path/to/ha/config/packages/
   ```

2. **Add to `configuration.yaml`:**
   ```yaml
   homeassistant:
     packages: !include_dir_named packages
   ```

3. **Configure REST commands:**
   - Copy `rest_commands.yaml` content to your HA config
   - Set environment variables or secrets:
     - `es_cluster_url`
     - `es_api_key`
     - `kibana_url`

4. **Set up Elasticsearch indices:**
   ```bash
   # Create index templates
   curl -X PUT "your-es-cluster/_index_template/sproutie-sensors-template" \
     -H "Authorization: ApiKey $ES_APIKEY" \
     -H "Content-Type: application/json" \
     -d @elasticsearch/indices/sproutie-sensors-template.json
   
   # Create botany logs index
   curl -X PUT "your-es-cluster/sproutie-botany-logs" \
     -H "Authorization: ApiKey $ES_APIKEY" \
     -H "Content-Type: application/json" \
     -d @elasticsearch/indices/sproutie-botany-logs.json
   ```

5. **Create ML anomaly detection job:**
   ```bash
   curl -X PUT "your-es-cluster/_ml/anomaly_detection/sproutie-anomaly-detection" \
     -H "Authorization: ApiKey $ES_APIKEY" \
     -H "Content-Type: application/json" \
     -d @elasticsearch/ml/anomaly-detection-job.json
   ```

6. **Set up FLORA agent:**
   - Create tools using `elasticsearch/tools/tool-definitions.yaml`
   - Create agent using `elasticsearch/agents/flora-agent-config.json`
   - See Elastic Agent Builder API docs for exact commands

7. **Deploy MCP Server:**
   ```bash
   cd mcp_server
   pip install -r requirements.txt
   export HA_URL="http://homeassistant:8123"
   export HA_ACCESS_TOKEN="your_token"
   python sproutie_mcp_server.py
   ```

8. **Add custom icons:**
   - Place SVG icons in `www/sproutie/icons/`
   - See `www/sproutie/icons/README.md` for list

## Configuration

### Entity IDs

The system expects these Home Assistant entities:

**Sensors:**
- `sensor.sproutie_outie_internal_temp`
- `sensor.sproutie_outie_internal_humidity`
- `sensor.caffrey_taffy_co_internal_temp`
- `sensor.caffrey_taffy_co_internal_humidity`

**Switches:**
- `switch.exhaust_fan`
- `switch.top_shelf_fan`
- `switch.bottom_shelf_fan`
- `switch.top_shelf_lights`
- `switch.bottom_shelf_lights`

**Input Helpers:**
- `input_number.target_temp`
- `input_number.target_humidity`
- `input_select.tray_1_crop`
- `input_select.tray_2_crop`

**Camera:**
- `camera.tent_inside_placeholder`

### Thresholds

Default thresholds (can be customized per sensor):
- **Temperature:** 60-75°F optimal, <60 or >80 alerts
- **Humidity:** 50-70% optimal, <40 or >85 alerts

## Usage

### Dashboard

Access the dashboard via Home Assistant:
- Navigate to "Sproutie Outie Control Center" dashboard
- View real-time sensor readings with mini-graphs
- Control fans and lights via holo-toggle cards
- Monitor threat level from anomaly detection
- View latest botany log entries

### FLORA Chat

- Access via separate "FLORA Chat" view
- Ask questions about tent conditions
- Request control actions (with confirmation)
- Query historical data
- Get growing advice

### Botany Logs

Automatically generated twice daily:
- **Morning log:** 8:00 AM
- **Evening log:** 8:00 PM

Logs are stored in Elasticsearch and can be queried via FLORA.

## File Structure

```
sproutie-outie-control/
├── packages/
│   └── sproutie_outie/
│       ├── templates.yaml          # Button card templates
│       ├── views/
│       │   ├── command_center.yaml # Main dashboard
│       │   └── flora_chat.yaml     # FLORA chat view
│       ├── automations.yaml        # ES ingestion, alerts
│       ├── sensors.yaml            # Template sensors
│       └── scripts.yaml            # Helper scripts
├── elasticsearch/
│   ├── indices/                    # ES index definitions
│   ├── ml/                         # ML job configs
│   ├── tools/                      # Agent Builder tools
│   └── agents/                     # FLORA agent config
├── mcp_server/                     # MCP server code
├── www/
│   └── sproutie/
│       └── icons/                  # Custom SVG icons
└── rest_commands.yaml              # HA REST commands
```

## Customization

### Colors

Edit templates to change color scheme:
- Cyan (optimal): `#00f3ff`
- Amber (warning): `#ffbf00`
- Pink (alert): `#ff00ff`
- Background: `rgba(8, 8, 8, 0.7)`

### Thresholds

Modify thresholds in `templates.yaml` or per-card in dashboard views.

### Icons

Replace SVG files in `www/sproutie/icons/` with your custom designs.

## Troubleshooting

### Dashboard not loading
- Check that all custom cards are installed via HACS
- Verify entity IDs match your HA setup
- Check browser console for errors

### Elasticsearch not receiving data
- Verify REST command configuration
- Check ES cluster URL and API key
- Review automation logs in HA

### FLORA not responding
- Verify Agent Builder agent is created
- Check MCP server is running
- Verify workflow tools are configured

## Phase 2 Features (Future)

- Harvest Timeline with Open Plantbook integration
- Growth Timelapse / Visual Journal
- Multi-Agent Architecture (specialists)
- Voice control integration
- Gamification / Achievements

## License

See LICENSE file.

## Credits

- Inspired by Blade Runner / Cyberpunk aesthetics
- Built for microgreen cultivation
- Powered by Home Assistant + Elastic Stack

