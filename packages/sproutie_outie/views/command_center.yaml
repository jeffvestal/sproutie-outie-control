# Sproutie OS v2.4 - Command Center
# Feature: Active Crop Manifest (Replaces vague stats)

title: Command Center
path: command-center
type: panel
cards:
  - type: vertical-stack
    cards:
      # ═══════════════════════════════════════════════════════════════════════
      # SECTION 0: CROP OVERVIEW (Fixed Links & Visibility)
      # ═══════════════════════════════════════════════════════════════════════
      - type: custom:stack-in-card
        card_mod:
          style: |
            ha-card {
              background: rgba(30, 30, 30, 0.6) !important;
              border-radius: 24px !important;
              border: none !important;
              padding: 16px !important;
            }
        cards:
          - type: custom:mushroom-template-card
            primary: Active Crops
            secondary: "Production Summary"
            icon: mdi:sprout
            icon_color: green
            card_mod:
              style: |
                ha-card { background: transparent !important; border: none !important; box-shadow: none !important; margin-bottom: 5px !important; }

          - type: markdown
            content: >
              <table width="100%" cellspacing="0" cellpadding="0" style="border-collapse: separate; border-spacing: 12px 12px; margin: -12px;">
              <tr>
              {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
              {%- set crop_lib = states('input_text.crop_library_json') | from_json(default={}) -%}
              {%- set ns = namespace(active_crops_str="", counter=0) -%}
              {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
              {%- set d = raw | from_json(default={}) -%}
              {%- set c = d.crop | default('Unknown') -%}
              {%- if c not in ns.active_crops_str -%}
              {%- set ns.active_crops_str = ns.active_crops_str ~ c ~ "," -%}
              {%- endif -%}
              {%- endif -%}
              {%- endfor -%}
              {%- set unique_crops = ns.active_crops_str.split(',') | select('!=', '') | list -%}
              {%- if unique_crops | length > 0 -%}
              {%- for target_crop in unique_crops -%}
              {%- set ns_stats = namespace(count=0, min_age=0, next_harvest_ts=9999999999, stage='Unknown') -%}
              {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
              {%- set d = raw | from_json(default={}) -%}
              {%- if d.crop == target_crop -%}
              {%- set ns_stats.count = ns_stats.count + 1 -%}
              {%- set planted = d.planted | as_datetime -%}
              {%- set age = ((as_timestamp(now()) - as_timestamp(planted)) / 86400) | int if planted else 0 -%}
              {%- if ns_stats.count == 1 or age > ns_stats.min_age -%}{%- set ns_stats.min_age = age -%}{%- set ns_stats.stage = d.phase -%}{%- endif -%}
              {%- set grow_days = crop_lib.get(target_crop, {}).get('grow_days', 10) | int -%}
              {%- set harvest_ts = as_timestamp(planted) + (grow_days * 86400) if planted else 0 -%}
              {%- if harvest_ts < ns_stats.next_harvest_ts -%}{%- set ns_stats.next_harvest_ts = harvest_ts -%}{%- endif -%}
              {%- endif -%}
              {%- endif -%}
              {%- endfor -%}
              {%- set days_left = ((ns_stats.next_harvest_ts - as_timestamp(now())) / 86400) | int -%}
              {%- set bg_color = 'rgba(67, 160, 71, 0.4)' if target_crop == 'Radish' else 'rgba(255, 111, 0, 0.4)' -%}
              {%- set icon = 'mdi:food-variant' if target_crop == 'Radish' else 'mdi:flower' -%}
              {%- if target_crop == 'Pea' %}{% set icon = 'mdi:sprout' %}{% set bg_color = 'rgba(0, 137, 123, 0.4)' %}{% endif -%}
              {# --- RENDER CARD CELL --- #}
              <td width="50%" valign="top" style="padding: 0;">
              <a href="/lovelace/workbench" style="text-decoration: none !important; color: inherit !important; display: block;">
              <div style="background-color: {{ bg_color }}; border-radius: 16px; padding: 16px; box-shadow: 0px 4px 8px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.15);">
              <div style="display: flex; align-items: center; margin-bottom: 16px;">
              <div style="background: rgba(0,0,0,0.2); border-radius: 50%; padding: 8px; margin-right: 12px;"><ha-icon icon="{{ icon }}" style="opacity: 1.0; --mdc-icon-size: 24px;"></ha-icon></div>
              <span style="font-size: 18px; font-weight: 700; line-height: 1.2;">{{ target_crop }}</span>
              </div>
              <div style="font-size: 11px; font-weight: 700; opacity: 0.6; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px;">Stage</div>
              <div style="font-size: 15px; font-weight: 500; margin-bottom: 16px;">{{ ns_stats.stage }} <span style="opacity: 0.7; font-size: 13px;">(Day {{ ns_stats.min_age }})</span></div>
              <div style="font-size: 11px; font-weight: 700; opacity: 0.6; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px;">Harvest In</div>
              <div style="font-size: 26px; font-weight: 800; line-height: 1; margin-bottom: 8px;">{% if days_left <= 0 %}Due Now{% else %}{{ days_left }} <span style="font-size: 16px; font-weight: 500;">Days</span>{% endif %}</div>
              <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px; margin-top: 12px; text-align: right; font-size: 12px; opacity: 0.9; font-weight: 500;">
              {{ ns_stats.count }} Tray{{ 's' if ns_stats.count > 1 }} Active
              </div>
              </div>
              </a>
              </td>
              {%- set ns.counter = ns.counter + 1 -%}
              {%- if ns.counter is divisibleby 2 -%}</tr><tr>{%- endif -%}
              {%- endfor -%}
              {%- else -%}
              <td colspan="2" align="center" style="padding: 30px; opacity: 0.5; font-style: italic;">System Idle. No active crops found.</td>
              {%- endif -%}
              </tr>
              </table>
            card_mod:
              style: |
                ha-card { background: transparent !important; border: none !important; box-shadow: none !important; }
                ha-markdown { padding: 0 !important; }

      # ═══════════════════════════════════════════════════════════════════════
      # SECTION 1: VITALS (Dual-Line Graphs)
      # ═══════════════════════════════════════════════════════════════════════
      - type: horizontal-stack
        cards:
          # Temperature
          - type: custom:mini-graph-card
            name: Temperature
            icon: mdi:thermometer
            entities:
              - entity: sensor.monitor2_temperature
                name: Tent
                color: "#e74c3c"
              - entity: sensor.govee_humidity_temp_monitor_temperature
                name: Room
                color: "#95a5a6"
                show_state: true
                y_axis: secondary
            hours_to_show: 24
            points_per_hour: 2
            line_width: 2
            show:
              graph: true
              fill: false
              labels: false
              legend: true
            card_mod:
              style: |
                ha-card { background: rgba(30, 30, 30, 0.6) !important; border-radius: 24px !important; border: none !important; }

          # Humidity
          - type: custom:mini-graph-card
            name: Humidity
            icon: mdi:water-percent
            entities:
              - entity: sensor.monitor2_humidity
                name: Tent
                color: "#3498db"
              - entity: sensor.govee_humidity_temp_monitor_humidity
                name: Room
                color: "#95a5a6"
                show_state: true
                y_axis: secondary
            hours_to_show: 24
            points_per_hour: 2
            line_width: 2
            show:
              graph: true
              fill: false
              labels: false
              legend: true
            card_mod:
              style: |
                ha-card { background: rgba(30, 30, 30, 0.6) !important; border-radius: 24px !important; border: none !important; }

          # VPD
          - type: custom:mini-graph-card
            name: VPD
            icon: mdi:gauge
            entities:
              - entity: sensor.sproutie_vpd
                name: Tent
                color: "#2ecc71"
            hours_to_show: 24
            points_per_hour: 2
            line_width: 2
            show:
              graph: true
              fill: true
            card_mod:
              style: |
                ha-card { background: rgba(30, 30, 30, 0.6) !important; border-radius: 24px !important; border: none !important; }

      # ═══════════════════════════════════════════════════════════════════════
      # SECTION 2: CONTROL DECK
      # ═══════════════════════════════════════════════════════════════════════
      - type: custom:layout-card
        layout_type: custom:grid-layout
        layout:
          grid-template-columns: 2fr 1fr
          gap: 16px
        cards:
          # LEFT: Cameras
          - type: vertical-stack
            cards:
              - type: picture-entity
                entity: camera.sproutie_outie_top_eyes
                name: Top Rack
                show_state: false
                aspect_ratio: 16:9
                card_mod:
                  style: |
                    ha-card { border-radius: 20px !important; overflow: hidden !important; }
              - type: picture-entity
                entity: camera.sproutie_outie_bottom_eyes
                name: Bottom Rack
                show_state: false
                aspect_ratio: 16:9
                card_mod:
                  style: |
                    ha-card { border-radius: 20px !important; overflow: hidden !important; margin-top: 16px !important; }

          # RIGHT: Hardware & Engineering
          - type: vertical-stack
            cards:
              # Hardware Controls
              - type: custom:stack-in-card
                card_mod:
                  style: |
                    ha-card { background: rgba(30, 30, 30, 0.6) !important; border-radius: 24px !important; padding: 16px !important; }
                cards:
                  - type: grid
                    columns: 2
                    square: false
                    cards:
                      - type: custom:mushroom-entity-card
                        entity: switch.top_shelf_lights
                        name: Top Lights
                        icon: mdi:lightbulb-group
                        icon_color: amber
                        tap_action: { action: toggle }
                        layout: vertical
                      - type: custom:mushroom-entity-card
                        entity: switch.bottom_shelf_lights
                        name: Bot Lights
                        icon: mdi:lightbulb-group
                        icon_color: amber
                        tap_action: { action: toggle }
                        layout: vertical
                      - type: custom:mushroom-entity-card
                        entity: switch.top_shelf_fan
                        name: Top Fan
                        icon: mdi:fan
                        icon_color: cyan
                        tap_action: { action: toggle }
                        layout: vertical
                      - type: custom:mushroom-entity-card
                        entity: switch.bottom_shelf_fan
                        name: Bot Fan
                        icon: mdi:fan
                        icon_color: cyan
                        tap_action: { action: toggle }
                        layout: vertical
                      - type: custom:mushroom-entity-card
                        entity: switch.exhaust_fan
                        name: Exhaust
                        icon: mdi:weather-windy
                        icon_color: teal
                        tap_action: { action: toggle }
                        layout: vertical
                      - type: custom:mushroom-entity-card
                        entity: input_boolean.inspection_mode
                        name: Inspect
                        icon: mdi:eye
                        icon_color: purple
                        tap_action:
                          action: call-service
                          service: script.toggle_inspection_mode
                        layout: vertical

              # Production & Interactive Scheduler
              - type: custom:stack-in-card
                card_mod:
                  style: |
                    ha-card { background: rgba(30, 30, 30, 0.6) !important; border-radius: 24px !important; padding: 16px !important; margin-top: 16px !important; }
                cards:
                  # Production Mode
                  - type: custom:mushroom-template-card
                    entity: input_boolean.production_mode
                    primary: Production Mode
                    secondary: "{% if is_state('input_boolean.production_mode', 'on') %}ACTIVE{% else %}STANDBY{% endif %}"
                    icon: mdi:power
                    icon_color: "{% if is_state('input_boolean.production_mode', 'on') %}green{% else %}red{% endif %}"
                    tap_action: { action: toggle }
                    card_mod:
                      style: |
                        ha-card {
                          background: {% if is_state('input_boolean.production_mode', 'on') %}rgba(46, 204, 113, 0.15){% else %}rgba(231, 76, 60, 0.15){% endif %} !important;
                          border: 1px solid {% if is_state('input_boolean.production_mode', 'on') %}rgba(46, 204, 113, 0.5){% else %}rgba(231, 76, 60, 0.5){% endif %} !important;
                          border-radius: 12px !important;
                          margin-bottom: 12px !important;
                        }

                  # Light Schedule Row
                  - type: custom:mushroom-template-card
                    primary: "Lights Schedule"
                    secondary: "{{ states('input_datetime.lights_on_time')[:5] }} - {{ states('input_datetime.lights_off_time')[:5] }}"
                    icon: mdi:clock-time-four-outline
                    icon_color: orange
                    tap_action:
                      action: fire-dom-event
                      browser_mod:
                        service: browser_mod.popup
                        data:
                          title: "Light Schedule"
                          content:
                            type: entities
                            entities:
                              - entity: input_datetime.lights_on_time
                                name: "Turn ON at"
                              - entity: input_datetime.lights_off_time
                                name: "Turn OFF at"
                  
                  # Exhaust Cycle Row
                  - type: custom:mushroom-template-card
                    primary: "Exhaust Cycle"
                    secondary: "{{ states('input_number.exhaust_on_duration')|int }}m ON / {{ states('input_number.exhaust_off_duration')|int }}m OFF"
                    icon: mdi:fan-clock
                    icon_color: teal
                    tap_action:
                      action: fire-dom-event
                      browser_mod:
                        service: browser_mod.popup
                        data:
                          title: "Exhaust Cycle Settings"
                          content:
                            type: entities
                            entities:
                              - entity: input_number.exhaust_on_duration
                                name: "Run for (minutes)"
                              - entity: input_number.exhaust_off_duration
                                name: "Pause for (minutes)"