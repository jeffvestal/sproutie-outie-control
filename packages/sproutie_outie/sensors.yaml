# Template sensors for Sproutie Outie Control Center
# Using legacy template format for package inclusion

sensor:
  # Anomaly Score Sensor (pulls from Elasticsearch)
  - platform: template
    sensors:
      sproutie_anomaly_score:
        friendly_name: "Sproutie Anomaly Score"
        unit_of_measurement: "%"
        value_template: >
          {% if states('sensor.sproutie_es_anomaly_score') not in ['unknown', 'unavailable', 'none'] %}
            {{ states('sensor.sproutie_es_anomaly_score') | int(0) }}
          {% else %}
            0
          {% endif %}
        icon_template: "mdi:alert-circle"

  # Latest Botany Log Sensor
  - platform: template
    sensors:
      sproutie_latest_botany_log:
        friendly_name: "Latest Botany Log"
        value_template: >
          {% if states('sensor.sproutie_es_latest_log') not in ['unknown', 'unavailable', 'none', ''] %}
            {{ states('sensor.sproutie_es_latest_log') }}
          {% else %}
            BOTANY LOG // INITIALIZING // SYSTEM STARTUP
            
            Sproutie Outie Control Center online. All systems nominal.
            Awaiting first log entry...
            
            - FLORA
          {% endif %}
        icon_template: "mdi:book-open-variant"

  # System Status Sensor (aggregate health check)
  - platform: template
    sensors:
      sproutie_system_status:
        friendly_name: "System Status"
        value_template: >
          {% set temp = states('sensor.sproutie_outie_internal_temp') | float(72) %}
          {% set humidity = states('sensor.sproutie_outie_internal_humidity') | float(60) %}
          {% if temp == 0 and humidity == 0 %}
            INITIALIZING
          {% elif temp > 80 or temp < 60 or humidity > 85 or humidity < 40 %}
            ALERT
          {% elif temp > 75 or temp < 65 or humidity > 70 or humidity < 50 %}
            WARNING
          {% else %}
            NOMINAL
          {% endif %}
        icon_template: >
          {% if is_state('sensor.sproutie_system_status', 'ALERT') %}
            mdi:alert-circle
          {% elif is_state('sensor.sproutie_system_status', 'WARNING') %}
            mdi:alert
          {% else %}
            mdi:check-circle
          {% endif %}

  # Days to Harvest (placeholder - will be enhanced in Phase 2)
  - platform: template
    sensors:
      sproutie_tray_1_days_to_harvest:
        friendly_name: "Tray 1 Days to Harvest"
        unit_of_measurement: "days"
        value_template: "7"
        icon_template: "mdi:calendar-clock"
  
      sproutie_tray_2_days_to_harvest:
        friendly_name: "Tray 2 Days to Harvest"
        unit_of_measurement: "days"
        value_template: "7"
        icon_template: "mdi:calendar-clock"
  
      sproutie_days_to_harvest:
        friendly_name: "Days to Harvest"
        value_template: >
          {% set tray1_crop = states('input_select.tray_1_crop') %}
          {% set tray2_crop = states('input_select.tray_2_crop') %}
          {% set crop_days = {
            'Radish': 6,
            'Sunflower': 10,
            'Pea Shoots': 8,
            'Broccoli': 10,
            'Mustard': 7,
            'Kale': 10,
            'Arugula': 7
          } %}
          {% set tray1_days = crop_days.get(tray1_crop, 7) %}
          {% set tray2_days = crop_days.get(tray2_crop, 7) %}
          {% if tray1_days <= tray2_days %}
            {{ tray1_days }}
          {% else %}
            {{ tray2_days }}
          {% endif %}
        icon_template: "mdi:calendar-clock"
  
      sproutie_es_anomaly_score_val:
        friendly_name: "Anomaly Score"
        value_template: >
          {% if states('sensor.sproutie_es_connection_status') == 'CONNECTED' %}
            {% if states('sensor.sproutie_es_latest_anomaly') not in ['unknown', 'unavailable', 'none', ''] %}
              {{ states('sensor.sproutie_es_latest_anomaly') | int(0) }}
            {% else %}
              0
            {% endif %}
          {% else %}
            0
          {% endif %}
        icon_template: "mdi:chart-bell-curve"

  # VPD (Vapor Pressure Deficit) Sensor
  # Formula: SVP = 0.61078 * e^((17.269 * T) / (T + 237.3)) where T is in Celsius
  # VPD = SVP * (1 - RH/100)
  - platform: template
    sensors:
      sproutie_vpd:
        friendly_name: "Sproutie VPD"
        unit_of_measurement: "kPa"
        value_template: >
          {% set T = states('sensor.sproutie_outie_internal_temp') | float(0) %}
          {% set RH = states('sensor.sproutie_outie_internal_humidity') | float(0) %}
          {% set T_degC = (T - 32) * 5/9 %}
          {% set SVP = 0.61078 * (2.71828 ** ((17.269 * T_degC) / (T_degC + 237.3))) %}
          {% set VPD = SVP * (1 - (RH / 100)) %}
          {{ VPD | round(2) }}
        icon_template: "mdi:water-percent"

  # Sproutie Outie (TENT) - Wrapped Hardware Sensors
  - platform: template
    sensors:
      sproutie_outie_internal_temp:
        friendly_name: "Sproutie Outie Internal Temp"
        unit_of_measurement: "°F"
        device_class: temperature
        value_template: "{{ states('sensor.monitor2_temperature') | float(0) }}"
        icon_template: "mdi:thermometer"
      
      sproutie_outie_internal_humidity:
        friendly_name: "Sproutie Outie Internal Humidity"
        unit_of_measurement: "%"
        device_class: humidity
        value_template: "{{ states('sensor.monitor2_humidity') | float(0) }}"
        icon_template: "mdi:water-percent"

  # Caffrey Taffy Co (ROOM) - Wrapped Hardware Sensors
  - platform: template
    sensors:
      caffrey_taffy_co_internal_temp:
        friendly_name: "Caffrey Taffy Co Internal Temp"
        unit_of_measurement: "°F"
        device_class: temperature
        value_template: "{{ states('sensor.govee_humidity_temp_monitor_temperature') | float(0) }}"
        icon_template: "mdi:thermometer"
      
      caffrey_taffy_co_internal_humidity:
        friendly_name: "Caffrey Taffy Co Internal Humidity"
        unit_of_measurement: "%"
        device_class: humidity
        value_template: "{{ states('sensor.govee_humidity_temp_monitor_humidity') | float(0) }}"
        icon_template: "mdi:water-percent"

  # Elasticsearch connection status
  - platform: template
    sensors:
      sproutie_es_connection_status:
        friendly_name: "Elasticsearch Connection"
        value_template: >
          {% if states('sensor.sproutie_es_last_success') not in ['unknown', 'unavailable', 'none'] %}
            {% set last_success = as_timestamp(states('sensor.sproutie_es_last_success')) | int(0) %}
            {% set now = as_timestamp(now()) | int(0) %}
            {% set diff = (now - last_success) | int %}
            {% if diff < 600 %}
              CONNECTED
            {% else %}
              DEGRADED
            {% endif %}
          {% else %}
            DISCONNECTED
          {% endif %}
        icon_template: >
          {% if is_state('sensor.sproutie_es_connection_status', 'CONNECTED') %}
            mdi:check-circle
          {% else %}
            mdi:alert-circle
          {% endif %}

  # Crop presence sensors for Command Center conditional cards
  - platform: template
    sensors:
      sproutie_has_radish:
        friendly_name: "Has Radish Active"
        value_template: >
          {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
          {%- set found = false -%}
          {%- for s in slots -%}
            {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
            {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
              {%- set d = raw | from_json(default={}) -%}
              {%- if d.crop == 'Radish' -%}
                {%- set found = true -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {%- if found -%}on{%- else -%}off{%- endif -%}
        icon_template: mdi:food-variant
      
      sproutie_has_sunflower:
        friendly_name: "Has Sunflower Active"
        value_template: >
          {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
          {%- set found = false -%}
          {%- for s in slots -%}
            {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
            {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
              {%- set d = raw | from_json(default={}) -%}
              {%- if d.crop == 'Sunflower' -%}
                {%- set found = true -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {%- if found -%}on{%- else -%}off{%- endif -%}
        icon_template: mdi:white-balance-sunny
      
      sproutie_has_pea:
        friendly_name: "Has Pea Active"
        value_template: >
          {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
          {%- set found = false -%}
          {%- for s in slots -%}
            {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
            {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
              {%- set d = raw | from_json(default={}) -%}
              {%- if d.crop == 'Pea' -%}
                {%- set found = true -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {%- if found -%}on{%- else -%}off{%- endif -%}
        icon_template: mdi:sprout
      
      sproutie_has_other:
        friendly_name: "Has Other Crops Active"
        value_template: >
          {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
          {%- set known_crops = ['Sunflower', 'Radish', 'Pea'] -%}
          {%- set found = false -%}
          {%- for s in slots -%}
            {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
            {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
              {%- set d = raw | from_json(default={}) -%}
              {%- if d.crop and d.crop not in known_crops -%}
                {%- set found = true -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {%- if found -%}on{%- else -%}off{%- endif -%}
        icon_template: mdi:leaf

  # ═══════════════════════════════════════════════════════════════════════
  # DYNAMIC CROP SUMMARY SENSOR
  # Aggregates ALL crops dynamically - no hardcoding!
  # State = number of unique crop types
  # Attribute 'crops' = JSON with full details per crop
  # ═══════════════════════════════════════════════════════════════════════
  - platform: template
    sensors:
      sproutie_crop_summary:
        friendly_name: "Sproutie Crop Summary"
        value_template: >
          {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
          {%- set ns = namespace(crops=[]) -%}
          {%- for s in slots -%}
            {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
            {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
              {%- set d = raw | from_json(default={}) -%}
              {%- if d.crop is defined and d.crop not in ns.crops -%}
                {%- set ns.crops = ns.crops + [d.crop] -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ ns.crops | length }}
        icon_template: mdi:sprout
        attribute_templates:
          crop_names: >
            {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
            {%- set ns = namespace(crops=[]) -%}
            {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                {%- set d = raw | from_json(default={}) -%}
                {%- if d.crop is defined and d.crop not in ns.crops -%}
                  {%- set ns.crops = ns.crops + [d.crop] -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {{ ns.crops | join(',') }}
          total_trays: >
            {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
            {%- set ns = namespace(count=0) -%}
            {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                {%- set d = raw | from_json(default={}) -%}
                {%- if d.crop is defined -%}
                  {%- set ns.count = ns.count + 1 -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {{ ns.count }}

  # ═══════════════════════════════════════════════════════════════════════
  # DYNAMIC CROP SLOT SENSORS (1-4)
  # Each sensor represents a "slot" for one unique crop type
  # State = crop name (or "none" if slot is empty)
  # Attributes = count, max_age, phase, days_to_harvest, bg_color, icon
  # FIXED: Uses simple count dict for sorting, then computes details
  # ═══════════════════════════════════════════════════════════════════════
  - platform: template
    sensors:
      sproutie_crop_1:
        friendly_name: "Active Crop 1"
        value_template: >
          {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
          {%- set ns = namespace(crops={}) -%}
          {%- for s in slots -%}
            {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
            {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
              {%- set d = raw | from_json(default={}) -%}
              {%- if d.crop is defined -%}
                {%- set crop_name = d.crop -%}
                {%- if crop_name in ns.crops -%}
                  {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                {%- else -%}
                  {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                {%- endif -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
          {%- if sorted_crops | length >= 1 -%}
            {{ sorted_crops[0][0] }}
          {%- else -%}
            none
          {%- endif -%}
        icon_template: mdi:sprout
        attribute_templates:
          count: >
            {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
            {%- set ns = namespace(crops={}) -%}
            {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                {%- set d = raw | from_json(default={}) -%}
                {%- if d.crop is defined -%}
                  {%- set crop_name = d.crop -%}
                  {%- if crop_name in ns.crops -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                  {%- else -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
            {%- if sorted_crops | length >= 1 -%}
              {{ sorted_crops[0][1] }}
            {%- else -%}
              0
            {%- endif -%}
          max_age: >
            {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
            {%- set ns = namespace(crops={}, target_crop='') -%}
            {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                {%- set d = raw | from_json(default={}) -%}
                {%- if d.crop is defined -%}
                  {%- set crop_name = d.crop -%}
                  {%- if crop_name in ns.crops -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                  {%- else -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
            {%- if sorted_crops | length >= 1 -%}
              {%- set ns.target_crop = sorted_crops[0][0] -%}
            {%- endif -%}
            {%- set ns2 = namespace(max_age=0) -%}
            {%- if ns.target_crop -%}
              {%- for s in slots -%}
                {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
                {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                  {%- set d = raw | from_json(default={}) -%}
                  {%- if d.crop == ns.target_crop and d.planted -%}
                    {%- set planted = d.planted | as_datetime -%}
                    {%- if planted -%}
                      {%- set age = ((as_timestamp(now()) - as_timestamp(planted)) / 86400) | int -%}
                      {%- if age > ns2.max_age -%}
                        {%- set ns2.max_age = age -%}
                      {%- endif -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            {{ ns2.max_age }}
          phase: >
            {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
            {%- set ns = namespace(crops={}, target_crop='') -%}
            {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                {%- set d = raw | from_json(default={}) -%}
                {%- if d.crop is defined -%}
                  {%- set crop_name = d.crop -%}
                  {%- if crop_name in ns.crops -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                  {%- else -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
            {%- if sorted_crops | length >= 1 -%}
              {%- set ns.target_crop = sorted_crops[0][0] -%}
            {%- endif -%}
            {%- set ns2 = namespace(max_age=0, phase='Growing') -%}
            {%- if ns.target_crop -%}
              {%- for s in slots -%}
                {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
                {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                  {%- set d = raw | from_json(default={}) -%}
                  {%- if d.crop == ns.target_crop -%}
                    {%- set planted = d.planted | as_datetime if d.planted else none -%}
                    {%- set age = ((as_timestamp(now()) - as_timestamp(planted)) / 86400) | int if planted else 0 -%}
                    {%- if age >= ns2.max_age -%}
                      {%- set ns2.max_age = age -%}
                      {%- set ns2.phase = d.phase | default('Growing') -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            {{ ns2.phase }}
          days_to_harvest: >
            {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
            {%- set ns = namespace(crops={}, target_crop='') -%}
            {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                {%- set d = raw | from_json(default={}) -%}
                {%- if d.crop is defined -%}
                  {%- set crop_name = d.crop -%}
                  {%- if crop_name in ns.crops -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                  {%- else -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
            {%- if sorted_crops | length >= 1 -%}
              {%- set ns.target_crop = sorted_crops[0][0] -%}
            {%- endif -%}
            {%- set ns2 = namespace(max_age=0) -%}
            {%- if ns.target_crop -%}
              {%- for s in slots -%}
                {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
                {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                  {%- set d = raw | from_json(default={}) -%}
                  {%- if d.crop == ns.target_crop and d.planted -%}
                    {%- set planted = d.planted | as_datetime -%}
                    {%- if planted -%}
                      {%- set age = ((as_timestamp(now()) - as_timestamp(planted)) / 86400) | int -%}
                      {%- if age > ns2.max_age -%}
                        {%- set ns2.max_age = age -%}
                      {%- endif -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            {%- set harvest_days = {
              'Radish': 6,
              'Sunflower': 10,
              'Pea': 8,
              'Wheatgrass': 7,
              'Broccoli': 10,
              'Kale': 10,
              'Arugula': 7
            } -%}
            {%- set total = harvest_days.get(ns.target_crop, 7) -%}
            {{ [0, total - ns2.max_age] | max }}
          bg_color: >
            {%- set crop = states('sensor.sproutie_crop_1') -%}
            {%- set colors = {
              'Radish': 'rgba(233,30,99,0.35)',
              'Sunflower': 'rgba(255,193,7,0.35)',
              'Pea': 'rgba(76,175,80,0.35)',
              'Wheatgrass': 'rgba(139,195,74,0.35)',
              'Broccoli': 'rgba(0,150,136,0.35)',
              'Kale': 'rgba(63,81,181,0.35)',
              'Arugula': 'rgba(156,39,176,0.35)'
            } -%}
            {{ colors.get(crop, 'rgba(96,125,139,0.35)') }}
          accent_color: >
            {%- set crop = states('sensor.sproutie_crop_1') -%}
            {%- set colors = {
              'Radish': '#e91e63',
              'Sunflower': '#ffc107',
              'Pea': '#4caf50',
              'Wheatgrass': '#8bc34a',
              'Broccoli': '#009688',
              'Kale': '#3f51b5',
              'Arugula': '#9c27b0'
            } -%}
            {{ colors.get(crop, '#607d8b') }}
          icon: >
            {%- set crop = states('sensor.sproutie_crop_1') -%}
            {%- set icons = {
              'Radish': 'mdi:food-variant',
              'Sunflower': 'mdi:white-balance-sunny',
              'Pea': 'mdi:seed',
              'Wheatgrass': 'mdi:grass',
              'Broccoli': 'mdi:food-broccoli',
              'Kale': 'mdi:leaf',
              'Arugula': 'mdi:spa'
            } -%}
            {{ icons.get(crop, 'mdi:sprout') }}

      sproutie_crop_2:
        friendly_name: "Active Crop 2"
        value_template: >
          {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
          {%- set ns = namespace(crops={}) -%}
          {%- for s in slots -%}
            {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
            {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
              {%- set d = raw | from_json(default={}) -%}
              {%- if d.crop is defined -%}
                {%- set crop_name = d.crop -%}
                {%- if crop_name in ns.crops -%}
                  {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                {%- else -%}
                  {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                {%- endif -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
          {%- if sorted_crops | length >= 2 -%}
            {{ sorted_crops[1][0] }}
          {%- else -%}
            none
          {%- endif -%}
        icon_template: mdi:sprout
        attribute_templates:
          count: >
            {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
            {%- set ns = namespace(crops={}) -%}
            {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                {%- set d = raw | from_json(default={}) -%}
                {%- if d.crop is defined -%}
                  {%- set crop_name = d.crop -%}
                  {%- if crop_name in ns.crops -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                  {%- else -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
            {%- if sorted_crops | length >= 2 -%}
              {{ sorted_crops[1][1] }}
            {%- else -%}
              0
            {%- endif -%}
          max_age: >
            {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
            {%- set ns = namespace(crops={}, target_crop='') -%}
            {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                {%- set d = raw | from_json(default={}) -%}
                {%- if d.crop is defined -%}
                  {%- set crop_name = d.crop -%}
                  {%- if crop_name in ns.crops -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                  {%- else -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
            {%- if sorted_crops | length >= 2 -%}
              {%- set ns.target_crop = sorted_crops[1][0] -%}
            {%- endif -%}
            {%- set ns2 = namespace(max_age=0) -%}
            {%- if ns.target_crop -%}
              {%- for s in slots -%}
                {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
                {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                  {%- set d = raw | from_json(default={}) -%}
                  {%- if d.crop == ns.target_crop and d.planted -%}
                    {%- set planted = d.planted | as_datetime -%}
                    {%- if planted -%}
                      {%- set age = ((as_timestamp(now()) - as_timestamp(planted)) / 86400) | int -%}
                      {%- if age > ns2.max_age -%}
                        {%- set ns2.max_age = age -%}
                      {%- endif -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            {{ ns2.max_age }}
          phase: >
            {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
            {%- set ns = namespace(crops={}, target_crop='') -%}
            {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                {%- set d = raw | from_json(default={}) -%}
                {%- if d.crop is defined -%}
                  {%- set crop_name = d.crop -%}
                  {%- if crop_name in ns.crops -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                  {%- else -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
            {%- if sorted_crops | length >= 2 -%}
              {%- set ns.target_crop = sorted_crops[1][0] -%}
            {%- endif -%}
            {%- set ns2 = namespace(max_age=0, phase='Growing') -%}
            {%- if ns.target_crop -%}
              {%- for s in slots -%}
                {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
                {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                  {%- set d = raw | from_json(default={}) -%}
                  {%- if d.crop == ns.target_crop -%}
                    {%- set planted = d.planted | as_datetime if d.planted else none -%}
                    {%- set age = ((as_timestamp(now()) - as_timestamp(planted)) / 86400) | int if planted else 0 -%}
                    {%- if age >= ns2.max_age -%}
                      {%- set ns2.max_age = age -%}
                      {%- set ns2.phase = d.phase | default('Growing') -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            {{ ns2.phase }}
          days_to_harvest: >
            {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
            {%- set ns = namespace(crops={}, target_crop='') -%}
            {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                {%- set d = raw | from_json(default={}) -%}
                {%- if d.crop is defined -%}
                  {%- set crop_name = d.crop -%}
                  {%- if crop_name in ns.crops -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                  {%- else -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
            {%- if sorted_crops | length >= 2 -%}
              {%- set ns.target_crop = sorted_crops[1][0] -%}
            {%- endif -%}
            {%- set ns2 = namespace(max_age=0) -%}
            {%- if ns.target_crop -%}
              {%- for s in slots -%}
                {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
                {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                  {%- set d = raw | from_json(default={}) -%}
                  {%- if d.crop == ns.target_crop and d.planted -%}
                    {%- set planted = d.planted | as_datetime -%}
                    {%- if planted -%}
                      {%- set age = ((as_timestamp(now()) - as_timestamp(planted)) / 86400) | int -%}
                      {%- if age > ns2.max_age -%}
                        {%- set ns2.max_age = age -%}
                      {%- endif -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            {%- set harvest_days = {
              'Radish': 6,
              'Sunflower': 10,
              'Pea': 8,
              'Wheatgrass': 7,
              'Broccoli': 10,
              'Kale': 10,
              'Arugula': 7
            } -%}
            {%- set total = harvest_days.get(ns.target_crop, 7) -%}
            {{ [0, total - ns2.max_age] | max }}
          bg_color: >
            {%- set crop = states('sensor.sproutie_crop_2') -%}
            {%- set colors = {
              'Radish': 'rgba(233,30,99,0.35)',
              'Sunflower': 'rgba(255,193,7,0.35)',
              'Pea': 'rgba(76,175,80,0.35)',
              'Wheatgrass': 'rgba(139,195,74,0.35)',
              'Broccoli': 'rgba(0,150,136,0.35)',
              'Kale': 'rgba(63,81,181,0.35)',
              'Arugula': 'rgba(156,39,176,0.35)'
            } -%}
            {{ colors.get(crop, 'rgba(96,125,139,0.35)') }}
          accent_color: >
            {%- set crop = states('sensor.sproutie_crop_2') -%}
            {%- set colors = {
              'Radish': '#e91e63',
              'Sunflower': '#ffc107',
              'Pea': '#4caf50',
              'Wheatgrass': '#8bc34a',
              'Broccoli': '#009688',
              'Kale': '#3f51b5',
              'Arugula': '#9c27b0'
            } -%}
            {{ colors.get(crop, '#607d8b') }}
          icon: >
            {%- set crop = states('sensor.sproutie_crop_2') -%}
            {%- set icons = {
              'Radish': 'mdi:food-variant',
              'Sunflower': 'mdi:white-balance-sunny',
              'Pea': 'mdi:seed',
              'Wheatgrass': 'mdi:grass',
              'Broccoli': 'mdi:food-broccoli',
              'Kale': 'mdi:leaf',
              'Arugula': 'mdi:spa'
            } -%}
            {{ icons.get(crop, 'mdi:sprout') }}

      sproutie_crop_3:
        friendly_name: "Active Crop 3"
        value_template: >
          {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
          {%- set ns = namespace(crops={}) -%}
          {%- for s in slots -%}
            {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
            {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
              {%- set d = raw | from_json(default={}) -%}
              {%- if d.crop is defined -%}
                {%- set crop_name = d.crop -%}
                {%- if crop_name in ns.crops -%}
                  {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                {%- else -%}
                  {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                {%- endif -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
          {%- if sorted_crops | length >= 3 -%}
            {{ sorted_crops[2][0] }}
          {%- else -%}
            none
          {%- endif -%}
        icon_template: mdi:sprout
        attribute_templates:
          count: >
            {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
            {%- set ns = namespace(crops={}) -%}
            {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                {%- set d = raw | from_json(default={}) -%}
                {%- if d.crop is defined -%}
                  {%- set crop_name = d.crop -%}
                  {%- if crop_name in ns.crops -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                  {%- else -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
            {%- if sorted_crops | length >= 3 -%}
              {{ sorted_crops[2][1] }}
            {%- else -%}
              0
            {%- endif -%}
          max_age: >
            {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
            {%- set ns = namespace(crops={}, target_crop='') -%}
            {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                {%- set d = raw | from_json(default={}) -%}
                {%- if d.crop is defined -%}
                  {%- set crop_name = d.crop -%}
                  {%- if crop_name in ns.crops -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                  {%- else -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
            {%- if sorted_crops | length >= 3 -%}
              {%- set ns.target_crop = sorted_crops[2][0] -%}
            {%- endif -%}
            {%- set ns2 = namespace(max_age=0) -%}
            {%- if ns.target_crop -%}
              {%- for s in slots -%}
                {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
                {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                  {%- set d = raw | from_json(default={}) -%}
                  {%- if d.crop == ns.target_crop and d.planted -%}
                    {%- set planted = d.planted | as_datetime -%}
                    {%- if planted -%}
                      {%- set age = ((as_timestamp(now()) - as_timestamp(planted)) / 86400) | int -%}
                      {%- if age > ns2.max_age -%}
                        {%- set ns2.max_age = age -%}
                      {%- endif -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            {{ ns2.max_age }}
          phase: >
            {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
            {%- set ns = namespace(crops={}, target_crop='') -%}
            {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                {%- set d = raw | from_json(default={}) -%}
                {%- if d.crop is defined -%}
                  {%- set crop_name = d.crop -%}
                  {%- if crop_name in ns.crops -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                  {%- else -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
            {%- if sorted_crops | length >= 3 -%}
              {%- set ns.target_crop = sorted_crops[2][0] -%}
            {%- endif -%}
            {%- set ns2 = namespace(max_age=0, phase='Growing') -%}
            {%- if ns.target_crop -%}
              {%- for s in slots -%}
                {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
                {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                  {%- set d = raw | from_json(default={}) -%}
                  {%- if d.crop == ns.target_crop -%}
                    {%- set planted = d.planted | as_datetime if d.planted else none -%}
                    {%- set age = ((as_timestamp(now()) - as_timestamp(planted)) / 86400) | int if planted else 0 -%}
                    {%- if age >= ns2.max_age -%}
                      {%- set ns2.max_age = age -%}
                      {%- set ns2.phase = d.phase | default('Growing') -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            {{ ns2.phase }}
          days_to_harvest: >
            {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
            {%- set ns = namespace(crops={}, target_crop='') -%}
            {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                {%- set d = raw | from_json(default={}) -%}
                {%- if d.crop is defined -%}
                  {%- set crop_name = d.crop -%}
                  {%- if crop_name in ns.crops -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                  {%- else -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
            {%- if sorted_crops | length >= 3 -%}
              {%- set ns.target_crop = sorted_crops[2][0] -%}
            {%- endif -%}
            {%- set ns2 = namespace(max_age=0) -%}
            {%- if ns.target_crop -%}
              {%- for s in slots -%}
                {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
                {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                  {%- set d = raw | from_json(default={}) -%}
                  {%- if d.crop == ns.target_crop and d.planted -%}
                    {%- set planted = d.planted | as_datetime -%}
                    {%- if planted -%}
                      {%- set age = ((as_timestamp(now()) - as_timestamp(planted)) / 86400) | int -%}
                      {%- if age > ns2.max_age -%}
                        {%- set ns2.max_age = age -%}
                      {%- endif -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            {%- set harvest_days = {
              'Radish': 6,
              'Sunflower': 10,
              'Pea': 8,
              'Wheatgrass': 7,
              'Broccoli': 10,
              'Kale': 10,
              'Arugula': 7
            } -%}
            {%- set total = harvest_days.get(ns.target_crop, 7) -%}
            {{ [0, total - ns2.max_age] | max }}
          bg_color: >
            {%- set crop = states('sensor.sproutie_crop_3') -%}
            {%- set colors = {
              'Radish': 'rgba(233,30,99,0.35)',
              'Sunflower': 'rgba(255,193,7,0.35)',
              'Pea': 'rgba(76,175,80,0.35)',
              'Wheatgrass': 'rgba(139,195,74,0.35)',
              'Broccoli': 'rgba(0,150,136,0.35)',
              'Kale': 'rgba(63,81,181,0.35)',
              'Arugula': 'rgba(156,39,176,0.35)'
            } -%}
            {{ colors.get(crop, 'rgba(96,125,139,0.35)') }}
          accent_color: >
            {%- set crop = states('sensor.sproutie_crop_3') -%}
            {%- set colors = {
              'Radish': '#e91e63',
              'Sunflower': '#ffc107',
              'Pea': '#4caf50',
              'Wheatgrass': '#8bc34a',
              'Broccoli': '#009688',
              'Kale': '#3f51b5',
              'Arugula': '#9c27b0'
            } -%}
            {{ colors.get(crop, '#607d8b') }}
          icon: >
            {%- set crop = states('sensor.sproutie_crop_3') -%}
            {%- set icons = {
              'Radish': 'mdi:food-variant',
              'Sunflower': 'mdi:white-balance-sunny',
              'Pea': 'mdi:seed',
              'Wheatgrass': 'mdi:grass',
              'Broccoli': 'mdi:food-broccoli',
              'Kale': 'mdi:leaf',
              'Arugula': 'mdi:spa'
            } -%}
            {{ icons.get(crop, 'mdi:sprout') }}

      sproutie_crop_4:
        friendly_name: "Active Crop 4"
        value_template: >
          {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
          {%- set ns = namespace(crops={}) -%}
          {%- for s in slots -%}
            {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
            {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
              {%- set d = raw | from_json(default={}) -%}
              {%- if d.crop is defined -%}
                {%- set crop_name = d.crop -%}
                {%- if crop_name in ns.crops -%}
                  {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                {%- else -%}
                  {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                {%- endif -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
          {%- if sorted_crops | length >= 4 -%}
            {{ sorted_crops[3][0] }}
          {%- else -%}
            none
          {%- endif -%}
        icon_template: mdi:sprout
        attribute_templates:
          count: >
            {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
            {%- set ns = namespace(crops={}) -%}
            {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                {%- set d = raw | from_json(default={}) -%}
                {%- if d.crop is defined -%}
                  {%- set crop_name = d.crop -%}
                  {%- if crop_name in ns.crops -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                  {%- else -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
            {%- if sorted_crops | length >= 4 -%}
              {{ sorted_crops[3][1] }}
            {%- else -%}
              0
            {%- endif -%}
          max_age: >
            {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
            {%- set ns = namespace(crops={}, target_crop='') -%}
            {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                {%- set d = raw | from_json(default={}) -%}
                {%- if d.crop is defined -%}
                  {%- set crop_name = d.crop -%}
                  {%- if crop_name in ns.crops -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                  {%- else -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
            {%- if sorted_crops | length >= 4 -%}
              {%- set ns.target_crop = sorted_crops[3][0] -%}
            {%- endif -%}
            {%- set ns2 = namespace(max_age=0) -%}
            {%- if ns.target_crop -%}
              {%- for s in slots -%}
                {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
                {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                  {%- set d = raw | from_json(default={}) -%}
                  {%- if d.crop == ns.target_crop and d.planted -%}
                    {%- set planted = d.planted | as_datetime -%}
                    {%- if planted -%}
                      {%- set age = ((as_timestamp(now()) - as_timestamp(planted)) / 86400) | int -%}
                      {%- if age > ns2.max_age -%}
                        {%- set ns2.max_age = age -%}
                      {%- endif -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            {{ ns2.max_age }}
          phase: >
            {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
            {%- set ns = namespace(crops={}, target_crop='') -%}
            {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                {%- set d = raw | from_json(default={}) -%}
                {%- if d.crop is defined -%}
                  {%- set crop_name = d.crop -%}
                  {%- if crop_name in ns.crops -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                  {%- else -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
            {%- if sorted_crops | length >= 4 -%}
              {%- set ns.target_crop = sorted_crops[3][0] -%}
            {%- endif -%}
            {%- set ns2 = namespace(max_age=0, phase='Growing') -%}
            {%- if ns.target_crop -%}
              {%- for s in slots -%}
                {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
                {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                  {%- set d = raw | from_json(default={}) -%}
                  {%- if d.crop == ns.target_crop -%}
                    {%- set planted = d.planted | as_datetime if d.planted else none -%}
                    {%- set age = ((as_timestamp(now()) - as_timestamp(planted)) / 86400) | int if planted else 0 -%}
                    {%- if age >= ns2.max_age -%}
                      {%- set ns2.max_age = age -%}
                      {%- set ns2.phase = d.phase | default('Growing') -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            {{ ns2.phase }}
          days_to_harvest: >
            {%- set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] -%}
            {%- set ns = namespace(crops={}, target_crop='') -%}
            {%- for s in slots -%}
              {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
              {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                {%- set d = raw | from_json(default={}) -%}
                {%- if d.crop is defined -%}
                  {%- set crop_name = d.crop -%}
                  {%- if crop_name in ns.crops -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: ns.crops[crop_name] + 1}) -%}
                  {%- else -%}
                    {%- set ns.crops = dict(ns.crops, **{crop_name: 1}) -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {%- set sorted_crops = ns.crops | dictsort(by='value', reverse=true) -%}
            {%- if sorted_crops | length >= 4 -%}
              {%- set ns.target_crop = sorted_crops[3][0] -%}
            {%- endif -%}
            {%- set ns2 = namespace(max_age=0) -%}
            {%- if ns.target_crop -%}
              {%- for s in slots -%}
                {%- set raw = states('input_text.slot_' ~ s ~ '_data') -%}
                {%- if raw not in ['unknown', 'unavailable', 'Empty', ''] -%}
                  {%- set d = raw | from_json(default={}) -%}
                  {%- if d.crop == ns.target_crop and d.planted -%}
                    {%- set planted = d.planted | as_datetime -%}
                    {%- if planted -%}
                      {%- set age = ((as_timestamp(now()) - as_timestamp(planted)) / 86400) | int -%}
                      {%- if age > ns2.max_age -%}
                        {%- set ns2.max_age = age -%}
                      {%- endif -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            {%- set harvest_days = {
              'Radish': 6,
              'Sunflower': 10,
              'Pea': 8,
              'Wheatgrass': 7,
              'Broccoli': 10,
              'Kale': 10,
              'Arugula': 7
            } -%}
            {%- set total = harvest_days.get(ns.target_crop, 7) -%}
            {{ [0, total - ns2.max_age] | max }}
          bg_color: >
            {%- set crop = states('sensor.sproutie_crop_4') -%}
            {%- set colors = {
              'Radish': 'rgba(233,30,99,0.35)',
              'Sunflower': 'rgba(255,193,7,0.35)',
              'Pea': 'rgba(76,175,80,0.35)',
              'Wheatgrass': 'rgba(139,195,74,0.35)',
              'Broccoli': 'rgba(0,150,136,0.35)',
              'Kale': 'rgba(63,81,181,0.35)',
              'Arugula': 'rgba(156,39,176,0.35)'
            } -%}
            {{ colors.get(crop, 'rgba(96,125,139,0.35)') }}
          accent_color: >
            {%- set crop = states('sensor.sproutie_crop_4') -%}
            {%- set colors = {
              'Radish': '#e91e63',
              'Sunflower': '#ffc107',
              'Pea': '#4caf50',
              'Wheatgrass': '#8bc34a',
              'Broccoli': '#009688',
              'Kale': '#3f51b5',
              'Arugula': '#9c27b0'
            } -%}
            {{ colors.get(crop, '#607d8b') }}
          icon: >
            {%- set crop = states('sensor.sproutie_crop_4') -%}
            {%- set icons = {
              'Radish': 'mdi:food-variant',
              'Sunflower': 'mdi:white-balance-sunny',
              'Pea': 'mdi:seed',
              'Wheatgrass': 'mdi:grass',
              'Broccoli': 'mdi:food-broccoli',
              'Kale': 'mdi:leaf',
              'Arugula': 'mdi:spa'
            } -%}
            {{ icons.get(crop, 'mdi:sprout') }}
