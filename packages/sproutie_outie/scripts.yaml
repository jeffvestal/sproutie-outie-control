# Sproutie OS v2.1 - Scripts
# Logic and External Connectors

rest_command:
  sproutie_push_to_elastic:
    url: !secret es_url_endpoint
    method: POST
    headers:
      Authorization: !secret es_api_key
      Content-Type: "application/json"
    payload: >-
      {
        "@timestamp": "{{ timestamp }}",
        "event.dataset": "sproutie.events",
        "sproutie": {
          {% if event_type == 'System Audit' %}
          "event_type": "System Audit",
          {% if audit_type is defined and audit_type != '' %}"audit_type": "{{ audit_type }}",{% endif %}
          {% if device is defined and device != '' %}"device": "{{ device }}",{% endif %}
          {% if action is defined and action != '' %}"action": "{{ action }}",{% endif %}
          "detail": "{{ detail | default('') }}",
          {% else %}
          "batch_id": "{{ batch_id | default('unknown') }}",
          "slot_id": "{{ slot_id | default('') }}",
          "event_type": "{{ event_type | default('Event') }}",
          "detail": "{{ detail | default('') }}",
          "photo_url": "{{ photo_url | default('') }}",
          {% endif %}
          "environment": {
            "temp": {{ temp | default(0) }},
            "humidity": {{ humidity | default(0) }}
          }
        }
      }
    content_type: "application/json"

script:
  sproutie_log_event:
    alias: "Sproutie Log Event"
    description: "Master script for logging events to Elasticsearch"
    fields:
      batch_id:
        description: "The batch ID (Tray ID)"
        example: "1768093958"
      slot_id:
        description: "Optional representative slot ID (A1-B8)"
        example: "A1"
      event_type:
        description: "Event type (Water, Phase Change, Issue, Harvest, Note, System Audit, etc.)"
        example: "Phase Change"
      detail:
        description: "Event detail/description"
        example: "Blackout"
      take_photo:
        description: "Whether to capture a photo snapshot"
        default: false
      audit_type:
        description: "For System Audit events: Hardware Change, Mode Change, etc."
        example: "Hardware Change"
      device:
        description: "For System Audit events: The device or mode being changed"
        example: "Exhaust Fan"
      action:
        description: "For System Audit events: The action taken (ON, OFF, ACTIVE, INACTIVE)"
        example: "ON"
    sequence:
      - variables:
          target_slot: >-
            {% set bid = batch_id | default('') %}
            {% set sid = slot_id | default('') %}
            {% if sid != '' %}
              {{ sid }}
            {% elif bid != '' %}
              {% set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] %}
              {% set ns = namespace(slot='') %}
              {% for s in slots %}
                {% if ns.slot == '' %}
                  {% set raw = states('input_text.slot_' ~ s ~ '_data') %}
                  {% if raw not in ['unknown', 'unavailable', 'Empty', ''] %}
                    {% set d = raw | from_json(default={}) %}
                    {% if d.get('id') | string | trim == bid | string | trim %}
                      {% set ns.slot = s | upper %}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endfor %}
              {{ ns.slot }}
            {% else %}
              
            {% endif %}
          matching_slots: >-
            {% set bid = batch_id | default('') %}
            {% set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] %}
            {% set ns = namespace(list=[]) %}
            {% if bid != '' %}
              {% for s in slots %}
                {% set raw = states('input_text.slot_' ~ s ~ '_data') %}
                {% if raw not in ['unknown', 'unavailable', 'Empty', ''] %}
                  {% set d = raw | from_json(default={}) %}
                  {% if d.get('id') | string | trim == bid | string | trim %}
                    {% set ns.list = ns.list + [s] %}
                  {% endif %}
                {% endif %}
              {% endfor %}
            {% endif %}
            {{ ns.list | to_json }}
      - variables:
          target_batch: >-
            {% set bid = batch_id | default('') %}
            {% if bid != '' %}
              {{ bid }}
            {% else %}
              {% set ts_lower = target_slot | lower %}
              {% if ts_lower != '' %}
                {% set raw = states('input_text.slot_' ~ ts_lower ~ '_data') %}
                {% if raw not in ['unknown', 'unavailable', 'Empty', ''] %}
                  {{ (raw | from_json(default={})).get('id', 'unknown') }}
                {% else %}
                  {{ states('input_text.selected_batch') | default('unknown') }}
                {% endif %}
              {% else %}
                {{ states('input_text.selected_batch') | default('unknown') }}
              {% endif %}
            {% endif %}
          event_detail: >-
            {% if event_type == 'Water' %}
              {{ states('input_select.watering_type') }}
            {% elif event_type == 'Note' %}
              {{ states('input_text.event_note') }}
            {% else %}
              {{ detail | default('') }}
            {% endif %}
          current_temp: "{{ states('sensor.sproutie_outie_internal_temp') | float(0) }}"
          current_humidity: "{{ states('sensor.sproutie_outie_internal_humidity') | float(0) }}"
          event_timestamp: >-
            {% set manual = states('input_datetime.manual_event_date') %}
            {% if manual not in ['unknown', 'unavailable', '0', '1970-01-01 00:00:00'] %}
              {{ as_datetime(manual).isoformat() }}
            {% else %}
              {{ now().isoformat() }}
            {% endif %}
          photo_url: ""
      - if:
          - condition: template
            value_template: "{{ take_photo | default(false) and target_slot != '' }}"
        then:
          - variables:
              camera_entity: >-
                {% if target_slot[0] | upper == 'A' %}
                  camera.top_eyes
                {% else %}
                  camera.bottom_eyes
                {% endif %}
              timestamp_str: "{{ as_timestamp(event_timestamp) | timestamp_custom('%Y%m%d_%H%M%S') }}"
              filename: "{{ target_slot | lower }}_{{ timestamp_str }}.jpg"
              snapshot_path: "/config/www/snapshots/{{ filename }}"
          - service: camera.snapshot
            target:
              entity_id: "{{ camera_entity }}"
            data:
              filename: "{{ snapshot_path }}"
          - variables:
              photo_url: "/local/snapshots/{{ filename }}"
      - if:
          - condition: template
            value_template: "{{ target_batch != 'unknown' }}"
        then:
          - repeat:
              for_each: "{{ matching_slots }}"
              sequence:
                - variables:
                    this_slot_raw: >-
                      {{ states('input_text.slot_' ~ repeat.item ~ '_data') }}
                - service: input_text.set_value
                  target:
                    entity_id: "input_text.slot_{{ repeat.item }}_data"
                  data:
                    value: >-
                      {% set d = this_slot_raw | from_json(default={}) %}
                      {% set e = {
                        "date": (as_timestamp(event_timestamp) | timestamp_custom('%Y-%m-%d')),
                        "event": event_type,
                        "note": event_detail[:20]
                      } %}
                      {% set result = {
                        "crop": d.get('crop', 'Unknown'),
                        "id": target_batch,
                        "planted": d.get('planted', ''),
                        "container": d.get('container', ''),
                        "phase": (event_detail if event_type == 'Phase Change' else d.get('phase', '')),
                        "seed_weight": d.get('seed_weight', 0),
                        "history": [e]
                      } %}
                      {{ result | to_json }}
      - service: rest_command.sproutie_push_to_elastic
        data:
          timestamp: "{{ event_timestamp }}"
          batch_id: "{{ target_batch }}"
          slot_id: "{{ target_slot }}"
          event_type: "{{ event_type }}"
          detail: "{{ event_detail }}"
          photo_url: "{{ photo_url }}"
          temp: "{{ current_temp }}"
          humidity: "{{ current_humidity }}"
          audit_type: "{{ audit_type | default('') }}"
          device: "{{ device | default('') }}"
          action: "{{ action | default('') }}"
      - service: browser_mod.notification
        data:
          message: >-
            {% if event_type == 'System Audit' %}
              System Audit logged
            {% else %}
              {{ event_type }} logged for Batch {{ target_batch }}
            {% endif %}
          duration: 3000
      - service: input_text.set_value
        target:
          entity_id: input_text.event_note
        data:
          value: ""
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.manual_event_date
        data:
          datetime: "1970-01-01 00:00:00"

  toggle_inspection_mode:
    alias: "Toggle Inspection Mode"
    description: "Toggle inspection: saves light state, kills grow lights, enables camera flash. Restores on toggle off."
    sequence:
      - choose:
          # CASE: Inspection is OFF -> Turn it ON
          - conditions:
              - condition: state
                entity_id: input_boolean.inspection_mode
                state: "off"
            sequence:
              # Save current light state
              - service: scene.create
                data:
                  scene_id: "sproutie_pre_inspection_scene"
                  snapshot_entities:
                    - switch.top_shelf_lights
                    - switch.bottom_shelf_lights
                    - switch.camera_flash
                    - input_boolean.inspection_mode
              # Kill grow lights
              - service: switch.turn_off
                target:
                  entity_id:
                    - switch.top_shelf_lights
                    - switch.bottom_shelf_lights
              # Enable camera flash (white light)
              - service: switch.turn_on
                target:
                  entity_id: switch.camera_flash
              # Set inspection mode ON
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.inspection_mode
        # DEFAULT: Inspection is ON -> Turn it OFF (restore)
        default:
          # Restore saved scene
          - service: scene.turn_on
            target:
              entity_id: scene.sproutie_pre_inspection_scene
          # Set inspection mode OFF
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.inspection_mode

  sproutie_plant_batch:
    alias: "Plant Batch"
    description: "Creates a new batch in the selected slot(s)"
    fields:
      slot_id:
        description: "The slot ID (A1-A8, B1-B8)"
        example: "A1"
    sequence:
      - variables:
          event_timestamp: >-
            {% set manual = states('input_datetime.manual_event_date') %}
            {% if manual not in ['unknown', 'unavailable', '0', '1970-01-01 00:00:00'] %}
              {{ as_datetime(manual).isoformat() }}
            {% else %}
              {{ now().isoformat() }}
            {% endif %}
          target_slot_base: "{{ slot_id | default(states('input_text.selected_slot')) }}"
          size: "{{ states('input_select.container_size') }}"
          zone: "{{ target_slot_base[0] | lower }}"
          num: "{{ target_slot_base[1:] | int }}"
          target_slots: >-
            {% if size == 'Full Shelf (10x20)' %}
              {{ [zone~'1', zone~'2', zone~'3', zone~'4', zone~'5', zone~'6', zone~'7', zone~'8'] }}
            {% elif size == 'Half Shelf (10x10)' %}
              {% if num <= 4 %} {{ [zone~'1', zone~'2', zone~'3', zone~'4'] }}
              {% else %} {{ [zone~'5', zone~'6', zone~'7', zone~'8'] }}
              {% endif %}
            {% else %}
              {{ [zone ~ num] }}
            {% endif %}
          batch_id: "{{ (as_timestamp(event_timestamp) | int(0)) + range(1, 999) | random }}"
          crop: "{{ states('input_select.planting_preset') }}"
          container: "{{ states('input_select.container_type') }}"
          seed_weight: "{{ states('input_number.seed_weight') | int(0) }}"
          plant_date: "{{ as_datetime(event_timestamp).strftime('%Y-%m-%d') }}"
          payload: >-
            {% set result = {
              "crop": crop,
              "id": batch_id,
              "planted": plant_date,
              "container": container,
              "phase": "Germination",
              "seed_weight": seed_weight,
              "history": []
            } %}
            {{ result | to_json }}
      - repeat:
          for_each: "{{ target_slots }}"
          sequence:
            - service: input_text.set_value
              target:
                entity_id: "input_text.slot_{{ repeat.item }}_data"
              data:
                value: "{{ payload }}"
      - service: rest_command.sproutie_push_to_elastic
        data:
          timestamp: "{{ event_timestamp }}"
          batch_id: "{{ batch_id | default('unknown') }}"
          slot_id: "{{ target_slot_base | default('') }}"
          event_type: "Planted"
          detail: "{{ crop | default('Unknown') }} planted in {{ container | default('Unknown') }} ({{ size | default('Unknown') }})"
          photo_url: ""
          temp: "{{ states('sensor.sproutie_outie_internal_temp') | float(0) }}"
          humidity: "{{ states('sensor.sproutie_outie_internal_humidity') | float(0) }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.selected_slot
        data:
          value: ""
      - service: browser_mod.notification
        data:
          message: "New {{ crop }} batch planted ({{ size }}) at {{ target_slot_base }}"
          duration: 5000
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.manual_event_date
        data:
          datetime: "1970-01-01 00:00:00"

  sproutie_harvest_batch:
    alias: "Harvest Batch"
    description: "Harvests and clears all slots in a batch"
    fields:
      batch_id:
        description: "The Batch ID to harvest (optional - falls back to selected_batch)"
        example: "1768093958"
    sequence:
      - variables:
          # Use provided batch_id, or fall back to selected_batch
          batch_id: >
            {% if batch_id is defined and batch_id | string | trim not in ['', 'unknown', 'None', 'none', 'unavailable', '{{ states', "{{ states"] %}
              {{ batch_id }}
            {% else %}
              {{ states('input_text.selected_batch') }}
            {% endif %}
      - if:
          - condition: template
            value_template: "{{ batch_id | string | trim in ['', 'unknown', 'None', 'none', 'unavailable'] }}"
        then:
          - service: browser_mod.notification
            data:
              message: "Error: Invalid Batch ID. Harvest cancelled."
              duration: 5000
          - stop: "Invalid Batch ID"
      - variables:
          harvest_weight: "{{ states('input_number.harvest_weight') | float(0) }}"
          harvest_note: "{{ states('input_text.event_note') }}"
          event_timestamp: >-
            {% set manual = states('input_datetime.manual_event_date') %}
            {% if manual not in ['unknown', 'unavailable', '0', '1970-01-01 00:00:00'] %}
              {{ as_datetime(manual).isoformat() }}
            {% else %}
              {{ now().isoformat() }}
            {% endif %}
          metadata: >-
            {% set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] %}
            {% set ns = namespace(found=false, crop='Unknown', seed_w=1, slot='', match_list=[]) %}
            {% for s in slots %}
              {% set raw = states('input_text.slot_' ~ s ~ '_data') %}
              {% if raw not in ['unknown', 'unavailable', 'Empty', ''] %}
                {% set d = raw | from_json(default={}) %}
                {% if d.get('id') | string | trim == batch_id | string | trim %}
                  {% set ns.match_list = ns.match_list + [s] %}
                  {% if not ns.found %}
                    {% set ns.found = true %}
                    {% set ns.crop = d.get('crop', 'Unknown') %}
                    {% set ns.seed_w = d.get('seed_weight', 1) %}
                    {% set ns.slot = s | upper %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ {'crop': ns.crop, 'seed_weight': ns.seed_w, 'representative_slot': ns.slot, 'matching_slots': ns.match_list} | to_json }}
          meta: "{{ metadata | trim | from_json(default={}) }}"
          yield_ratio: "{{ (harvest_weight | float(0) / meta.get('seed_weight', 1) | float(1)) | round(2) if meta.get('seed_weight', 1) | float(1) > 0 else 0 }}"
          raw_data: >-
            {% set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] %}
            {% set ns = namespace(found=false, data={}) %}
            {% for s in slots %}
              {% if not ns.found %}
                {% set raw = states('input_text.slot_' ~ s ~ '_data') %}
                {% if raw not in ['unknown', 'unavailable', 'Empty', ''] %}
                  {% set d = raw | from_json(default={}) %}
                  {% if d.get('id') | string | trim == batch_id | string | trim %}
                    {% set ns.found = true %}
                    {% set ns.data = d %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ ns.data | to_json }}
      - service: rest_command.sproutie_push_to_elastic
        data:
          timestamp: "{{ event_timestamp }}"
          batch_id: "{{ batch_id | default('unknown') }}"
          slot_id: "{{ meta.get('representative_slot', 'Unknown') }}"
          event_type: "Harvested"
          detail: "Yield: {{ harvest_weight }}g ({{ yield_ratio }}x). Note: {{ harvest_note | default('') }}"
          photo_url: ""
          temp: "{{ states('sensor.sproutie_outie_internal_temp') | float(0) }}"
          humidity: "{{ states('sensor.sproutie_outie_internal_humidity') | float(0) }}"
      - service: rest_command.sproutie_es_log_harvest
        data:
          timestamp: "{{ event_timestamp }}"
          batch_id: "{{ batch_id | default('unknown') }}"
          crop: "{{ meta.get('crop', 'Unknown') }}"
          planted_date: "{{ (raw_data | from_json(default={})).get('planted', '') }}"
          harvest_date: "{{ now().strftime('%Y-%m-%d') }}"
          seed_weight: "{{ meta.get('seed_weight', 0) }}"
          harvest_weight: "{{ harvest_weight }}"
          efficiency: "{{ yield_ratio }}"
          notes: "{{ harvest_note | default('') }}"
          history: "{{ (raw_data | from_json(default={})).get('history', []) }}"
      - repeat:
          for_each: "{{ meta.matching_slots }}"
          sequence:
            - service: input_text.set_value
              target:
                entity_id: "input_text.slot_{{ repeat.item }}_data"
              data:
                value: "Empty"
      - service: input_number.set_value
        target:
          entity_id: input_number.harvest_weight
        data:
          value: 0
      - service: input_text.set_value
        target:
          entity_id: input_text.event_note
        data:
          value: ""
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.manual_event_date
        data:
          datetime: "1970-01-01 00:00:00"
      - service: browser_mod.notification
        data:
          message: "Harvested {{ meta.get('crop', 'Unknown') }} (Batch {{ batch_id | default('unknown') }}): {{ harvest_weight }}g"
          duration: 5000

  sproutie_advance_phase:
    alias: "Advance to Next Phase"
    description: "Transitions batch to the next growth phase"
    fields:
      batch_id:
        description: "The batch ID"
        example: "1768093958"
    sequence:
      - variables:
          safe_batch_id: >-
            {% set bid = batch_id | default('') %}
            {% if bid != '' and bid != None %}
              {{ bid }}
            {% else %}
              {{ states('input_text.selected_batch') }}
            {% endif %}
          next_phase: "{{ states('input_select.phase_transition') }}"
      - service: script.sproutie_log_event
        data:
          batch_id: "{{ safe_batch_id }}"
          event_type: "Phase Change"
          detail: "{{ next_phase }}"
          take_photo: true

  sproutie_log_issue:
    alias: "Log Issue"
    description: "Logs an issue for a batch"
    fields:
      batch_id:
        description: "The batch ID"
        example: "1768093958"
    sequence:
      - variables:
          issue_detail: "{{ states('input_text.issue_note') }}"
          safe_batch_id: "{{ batch_id | default(states('input_text.selected_batch')) }}"
      - service: script.sproutie_log_event
        data:
          batch_id: "{{ safe_batch_id }}"
          event_type: "Issue"
          detail: "{{ issue_detail }}"
          take_photo: true
      - service: input_text.set_value
        target:
          entity_id: input_text.issue_note
        data:
          value: ""

  sequence_crop_photography:
    alias: "Sequence Crop Photography"
    description: "Turns on the flash, takes snapshots for all active crops, and turns off the flash"
    sequence:
      - service: scene.create
        data:
          scene_id: "sproutie_pre_photo_scene"
          snapshot_entities:
            - switch.top_shelf_lights
            - switch.bottom_shelf_lights
      - service: switch.turn_off
        target:
          entity_id:
            - switch.top_shelf_lights
            - switch.bottom_shelf_lights
      - delay: "00:00:01"
      - service: switch.turn_on
        target:
          entity_id: switch.camera_flash
      - delay: "00:00:05"
      - variables:
          timestamp: "{{ now().strftime('%Y%m%d_%H%M%S') }}"
          active_crops: >-
            {% set slots = ['a1','a2','a3','a4','a5','a6','a7','a8','b1','b2','b3','b4','b5','b6','b7','b8'] %}
            {% set ns = namespace(batches={}) %}
            {% for s in slots %}
              {% set raw = states('input_text.slot_' ~ s ~ '_data') %}
              {% if raw not in ['unknown', 'unavailable', 'Empty', ''] %}
                {% set d = raw | from_json(default={}) %}
                {% if d.get('id') is defined %}
                  {% set ns.batches = dict(ns.batches, **{d.get('id') | string: s}) %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ ns.batches.items() | list }}
      - repeat:
          for_each: "{{ active_crops }}"
          sequence:
            - variables:
                batch_id: "{{ repeat.item[0] }}"
                slot_id: "{{ repeat.item[1] }}"
                # ADDED: Get the crop name from input_text
                crop_data: "{{ states('input_text.slot_' ~ slot_id | lower ~ '_data') | from_json(default={}) }}"
                crop_name: "{{ crop_data.get('crop', 'unknown') | replace(' ', '_') | lower }}"
                camera_entity: >-
                  {% if slot_id[0] | upper == 'A' %}
                    camera.top_eyes
                  {% else %}
                    camera.bottom_eyes
                  {% endif %}
                # CHANGED: New filename format
                full_filename: "{{ crop_name }}_{{ batch_id | default('unknown') }}_{{ timestamp }}.jpg"
            - service: camera.snapshot
              target:
                entity_id: "{{ camera_entity }}"
              data:
                filename: "/config/www/snapshots/{{ full_filename }}"
              continue_on_error: true
            - delay: "00:00:02"
            - service: shell_command.copy_snapshot
              data:
                source: "/config/www/snapshots/{{ full_filename }}"
                target: >-
                  {% if slot_id[0] | upper == 'A' %}
                    /media/snapshots/top_eyes_latest.jpg
                  {% else %}
                    /media/snapshots/bottom_eyes_latest.jpg
                  {% endif %}
              continue_on_error: true
            - service: shell_command.upload_snapshot_to_gcp
              data:
                filename: "/config/www/snapshots/{{ full_filename }}"
              continue_on_error: true
            - service: rest_command.sproutie_push_to_elastic
              data:
                timestamp: "{{ now().isoformat() }}"
                batch_id: "{{ batch_id | default('unknown') }}"
                slot_id: "{{ slot_id }}"
                event_type: "Snapshot"
                detail: "Periodic photography sequence snapshot"
                photo_url: "/local/snapshots/{{ full_filename }}"
                temp: "{{ states('sensor.sproutie_outie_internal_temp') | float(0) }}"
                humidity: "{{ states('sensor.sproutie_outie_internal_humidity') | float(0) }}"
              continue_on_error: true
      - delay: "00:00:02"
      - service: switch.turn_off
        target:
          entity_id: switch.camera_flash
        continue_on_error: true
      - service: scene.turn_on
        target:
          entity_id: scene.sproutie_pre_photo_scene
        continue_on_error: true
      - service: homeassistant.update_entity
        target:
          entity_id:
            - camera.top_eyes_snapshot
            - camera.bottom_eyes_snapshot
      - delay: "00:00:02"
      - service: homeassistant.update_entity
        target:
          entity_id:
            - camera.top_eyes_snapshot
            - camera.bottom_eyes_snapshot
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_photography_success
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"

  sproutie_ui_select_crop:
    alias: "UI: Select Crop and Navigate"
    fields:
      crop:
        description: "Crop name to select"
      batch_id:
        description: "Batch ID to select"
    sequence:
      - service: input_text.set_value
        target:
          entity_id: input_text.selected_crop
        data:
          value: "{{ crop }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.selected_batch
        data:
          value: "{{ batch_id | default('unknown') }}"
      - service: browser_mod.navigate
        data:
          path: "/sproutie-os/crop-details"

  sproutie_log_activity:
    alias: "Sproutie Log Activity"
    description: "UI helper to log basic activities (Water, Note, Phase)"
    fields:
      action:
        description: "The action to log (water, note, phase)"
      slot:
        description: "Optional slot ID"
    sequence:
      - variables:
          target_slot: "{{ slot | default(states('input_text.selected_batch')) }}"
          event_type: >-
            {% if action == 'water' %}Water{% elif action == 'note' %}Note{% elif action == 'phase' %}Phase Change{% else %}Unknown{% endif %}
          event_detail: >-
            {% if action == 'phase' %}{{ states('input_select.growth_phase') }}{% else %}{{ '' }}{% endif %}
      - service: script.sproutie_log_event
        data:
          slot_id: "{{ target_slot }}"
          event_type: "{{ event_type }}"
          detail: "{{ event_detail }}"
          take_photo: "{{ true if action == 'phase' else false }}"