# REST Command definitions for Sproutie Outie Control Center
# Add these to your Home Assistant configuration.yaml or packages/sproutie_outie/rest_commands.yaml

# Elasticsearch Bulk Index Command
sproutie_es_bulk_index:
  url: "{{ es_cluster_url }}/sproutie-sensors-*/_bulk"
  method: POST
  headers:
    Authorization: "ApiKey {{ es_api_key }}"
    Content-Type: "application/x-ndjson"
  payload: |
    {"index":{}}
    {"@timestamp":"{{ timestamp }}","tent_temp":{{ tent_temp }},"tent_humidity":{{ tent_humidity }},"room_temp":{{ room_temp }},"room_humidity":{{ room_humidity }},"fan_exhaust":{{ fan_exhaust }},"fan_top":{{ fan_top }},"fan_bottom":{{ fan_bottom }},"lights_top":{{ lights_top }},"lights_bottom":{{ lights_bottom }}}
  content_type: "application/x-ndjson"

# Get Anomaly Score from Elasticsearch
sproutie_es_get_anomaly_score:
  url: "{{ es_cluster_url }}/sproutie-anomaly-results/_search"
  method: POST
  headers:
    Authorization: "ApiKey {{ es_api_key }}"
    Content-Type: "application/json"
  payload: |
    {
      "size": 1,
      "sort": [{"@timestamp": {"order": "desc"}}],
      "_source": ["anomaly_score", "@timestamp"]
    }
  content_type: "application/json"

# Store Botany Log Entry
sproutie_es_store_botany_log:
  url: "{{ es_cluster_url }}/sproutie-botany-logs/_doc"
  method: POST
  headers:
    Authorization: "ApiKey {{ es_api_key }}"
    Content-Type: "application/json"
  payload: |
    {
      "@timestamp": "{{ timestamp }}",
      "log_type": "{{ log_type }}",
      "content": "{{ log_content }}",
      "conditions_summary": {
        "temp": {{ current_temp }},
        "humidity": {{ current_humidity }},
        "tray_1_crop": "{{ tray_1_crop }}",
        "tray_2_crop": "{{ tray_2_crop }}"
      }
    }
  content_type: "application/json"

# Get Recent Events for Botany Log Context
sproutie_es_get_recent_events:
  url: "{{ es_cluster_url }}/sproutie-sensors-*/_search"
  method: POST
  headers:
    Authorization: "ApiKey {{ es_api_key }}"
    Content-Type: "application/json"
  payload: |
    {
      "size": 100,
      "query": {
        "range": {
          "@timestamp": {
            "gte": "now-{{ hours }}h"
          }
        }
      },
      "sort": [{"@timestamp": {"order": "desc"}}]
    }
  content_type: "application/json"

# Log Alert Event
sproutie_es_log_alert:
  url: "{{ es_cluster_url }}/sproutie-alerts/_doc"
  method: POST
  headers:
    Authorization: "ApiKey {{ es_api_key }}"
    Content-Type: "application/json"
  payload: |
    {
      "@timestamp": "{{ timestamp }}",
      "alert_type": "{{ alert_type }}",
      "value": {{ value }}
    }
  content_type: "application/json"

# Call FLORA Agent to Generate Log
sproutie_flora_generate_log:
  url: "{{ kibana_url }}/api/agent_builder/agents/flora-sproutie-agent/converse"
  method: POST
  headers:
    Authorization: "ApiKey {{ es_api_key }}"
    Content-Type: "application/json"
    kbn-xsrf: "true"
    x-elastic-internal-origin: "kibana"
  payload: |
    {
      "messages": [
        {
          "role": "user",
          "content": "Generate a {{ log_type }} botany log entry. Current conditions: Temp {{ current_temp }}Â°F, Humidity {{ current_humidity }}%. Tray 1: {{ tray_1_crop }}, Tray 2: {{ tray_2_crop }}. Recent events: {{ recent_events }}"
        }
      ]
    }
  content_type: "application/json"

